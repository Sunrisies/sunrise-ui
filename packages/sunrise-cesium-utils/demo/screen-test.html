<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>屏幕坐标测试 - Cesium 工具库</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="cesium/Cesium.js"></script>
    <link href="cesium/widgets.min.css" rel="stylesheet" />
    <script src="../dist/index.min.js"></script>
    <script src="js/utils.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>屏幕坐标测试</h1>
        <p>测试屏幕坐标与经纬度的相互转换，实体选择等功能</p>
        <a href="index.html" class="back-btn">← 返回主页面</a>
      </header>

      <div class="content">
        <div id="cesiumContainer"></div>

        <div class="control-panel">
          <div class="section">
            <h2 class="section-title">屏幕坐标测试</h2>

            <div class="input-group">
              <label>屏幕坐标转经纬度</label>
              <div class="result" id="screenToLonLatResult">
                点击地图任意位置查看坐标转换结果
              </div>
            </div>

            <div class="input-group">
              <label>经纬度转屏幕坐标</label>
              <div class="coordinates">
                <input
                  type="number"
                  id="lonInput"
                  placeholder="经度"
                  value="116.3974"
                  step="0.0001"
                />
                <input
                  type="number"
                  id="latInput"
                  placeholder="纬度"
                  value="39.9093"
                  step="0.0001"
                />
              </div>
              <button id="lonLatToScreenBtn">转换为屏幕坐标</button>
              <div class="result" id="lonLatToScreenResult"></div>
            </div>

            <div class="input-group">
              <label>世界坐标转屏幕坐标</label>
              <button id="worldToScreenBtn">获取当前相机位置的屏幕坐标</button>
              <div class="result" id="worldToScreenResult"></div>
            </div>

            <div class="input-group">
              <label>实体选择</label>
              <div class="result" id="pickEntityResult">
                点击地图上的实体查看选择结果
              </div>
            </div>

            <div class="input-group">
              <label>检查坐标是否在画布内</label>
              <div class="coordinates">
                <input
                  type="number"
                  id="checkX"
                  placeholder="X坐标"
                  value="400"
                  step="1"
                />
                <input
                  type="number"
                  id="checkY"
                  placeholder="Y坐标"
                  value="300"
                  step="1"
                />
              </div>
              <button id="checkInCanvasBtn">检查坐标</button>
              <div class="result" id="checkInCanvasResult"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="status" id="status">就绪</div>
    </div>

    <script>
      const { CameraUtils, CoordinateUtils, ScreenUtils } = SunriseCesiumUtils;
      console.log(
        "Cesium version:",
        Cesium,
        CameraUtils,
        CoordinateUtils,
        ScreenUtils
      );
      Cesium.Ion.defaultAccessToken =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyYmY4NjhkYy1kZThlLTQyOWMtOGYzNi04Yzk5Nzc1NDAxOTQiLCJpZCI6MzMyNDkzLCJpYXQiOjE3NTUzMzIwODZ9.myLWfCJ3Xijjw-bFY3mpV7hOHktDmvr6_AttNXN_pEY";
      // 初始化查看器
      const viewer = new Cesium.Viewer("cesiumContainer", {
        timeline: false,
        animation: false,
        baseLayerPicker: false,
        geocoder: false,
        homeButton: false,
        sceneModePicker: false,
        navigationHelpButton: false,
        fullscreenButton: false,
      });

      // 设置初始视角
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(116.3974, 39.9093, 1500),
        orientation: {
          heading: 0,
          pitch: -Math.PI / 4,
          roll: 0,
        },
      });

      // 添加一些默认实体用于测试
      const redPoint = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(116.3974, 39.9093),
        point: {
          pixelSize: 10,
          color: Cesium.Color.RED,
          outlineColor: Cesium.Color.WHITE,
          outlineWidth: 2,
          heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
        },
        label: {
          text: "天安门",
          font: "14pt monospace",
          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          outlineWidth: 2,
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
          pixelOffset: new Cesium.Cartesian2(0, -20),
          heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
        },
      });

      // 更新状态信息
      function updateStatus(message) {
        const statusEl = document.getElementById("status");
        statusEl.textContent = message;

        // 3秒后清除状态
        setTimeout(() => {
          if (statusEl.textContent === message) {
            statusEl.textContent = "就绪";
          }
        }, 3000);
      }

      // 屏幕坐标转经纬度测试
      viewer.screenSpaceEventHandler.setInputAction((movement) => {
        const position = movement.position;
        const lonLat = ScreenUtils.screenToLonLat(viewer, position);

        if (lonLat) {
          document.getElementById(
            "screenToLonLatResult"
          ).textContent = `经度: ${lonLat.Lon.toFixed(
            6
          )}, 纬度: ${lonLat.Lat.toFixed(6)}`;

          // 在地球上标记点击位置
          const clickPoint = viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(lonLat.Lon, lonLat.Lat),
            point: {
              pixelSize: 8,
              color: Cesium.Color.YELLOW,
              outlineColor: Cesium.Color.BLACK,
              outlineWidth: 1,
              heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
            },
          });

          // 5秒后移除标记
          setTimeout(() => {
            viewer.entities.remove(clickPoint);
          }, 5000);

          updateStatus(
            `点击位置: 经度 ${lonLat.Lon.toFixed(6)}, 纬度 ${lonLat.Lat.toFixed(
              6
            )}`
          );
        } else {
          document.getElementById("screenToLonLatResult").textContent =
            "无法获取该位置的经纬度";
          updateStatus("无法获取该位置的经纬度");
        }
      }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

      // 经纬度转屏幕坐标测试
      document
        .getElementById("lonLatToScreenBtn")
        .addEventListener("click", () => {
          const lon = parseFloat(document.getElementById("lonInput").value);
          const lat = parseFloat(document.getElementById("latInput").value);

          if (isNaN(lon) || isNaN(lat)) {
            document.getElementById("lonLatToScreenResult").textContent =
              "请输入有效的经纬度";
            updateStatus("请输入有效的经纬度");
            return;
          }

          const screenPos = ScreenUtils.lonLatToScreen(viewer, lon, lat);

          if (screenPos) {
            document.getElementById(
              "lonLatToScreenResult"
            ).textContent = `屏幕坐标: X=${screenPos.x.toFixed(
              0
            )}, Y=${screenPos.y.toFixed(0)}`;

            // 在屏幕上标记位置
            createScreenMarker(screenPos.x, screenPos.y);

            updateStatus(
              `屏幕坐标: X=${screenPos.x.toFixed(0)}, Y=${screenPos.y.toFixed(
                0
              )}`
            );
          } else {
            document.getElementById("lonLatToScreenResult").textContent =
              "该位置不在屏幕内或转换失败";
            updateStatus("该位置不在屏幕内或转换失败");
          }
        });

      // 世界坐标转屏幕坐标测试
      document
        .getElementById("worldToScreenBtn")
        .addEventListener("click", () => {
          const cameraPosition = CameraUtils.getCurrentPosition(viewer);
          const screenPos = ScreenUtils.worldToScreen(viewer, cameraPosition);

          if (screenPos) {
            document.getElementById(
              "worldToScreenResult"
            ).textContent = `屏幕坐标: X=${screenPos.x.toFixed(
              0
            )}, Y=${screenPos.y.toFixed(0)}`;

            updateStatus(
              `屏幕坐标: X=${screenPos.x.toFixed(0)}, Y=${screenPos.y.toFixed(
                0
              )}`
            );
          } else {
            document.getElementById("worldToScreenResult").textContent =
              "相机位置不在屏幕内或转换失败";
            updateStatus("相机位置不在屏幕内或转换失败");
          }
        });

      // 实体选择测试
      viewer.screenSpaceEventHandler.setInputAction((movement) => {
        const entity = ScreenUtils.pickEntity(viewer, movement.position);

        if (entity) {
          document.getElementById(
            "pickEntityResult"
          ).textContent = `选中的实体: ${entity.id || "未命名实体"}`;
          updateStatus(`选中的实体: ${entity.id || "未命名实体"}`);
        } else {
          document.getElementById("pickEntityResult").textContent =
            "未选中任何实体";
          updateStatus("未选中任何实体");
        }
      }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

      // 检查坐标是否在画布内测试
      document
        .getElementById("checkInCanvasBtn")
        .addEventListener("click", () => {
          const x = parseFloat(document.getElementById("checkX").value);
          const y = parseFloat(document.getElementById("checkY").value);

          if (isNaN(x) || isNaN(y)) {
            document.getElementById("checkInCanvasResult").textContent =
              "请输入有效的坐标";
            updateStatus("请输入有效的坐标");
            return;
          }

          const screenPos = new Cesium.Cartesian2(x, y);
          const isInCanvas = ScreenUtils.isInCanvas(viewer, screenPos);

          document.getElementById(
            "checkInCanvasResult"
          ).textContent = `坐标 (${x}, ${y}) ${
            isInCanvas ? "在" : "不在"
          }画布内`;
          updateStatus(`坐标 (${x}, ${y}) ${isInCanvas ? "在" : "不在"}画布内`);
        });

      // 初始化完成
      updateStatus("屏幕坐标测试页面已就绪");
    </script>
  </body>
</html>
